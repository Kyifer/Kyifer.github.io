<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Submit Strike Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
      }
      .form-input {
        background-color: #1f2937;
        border-color: #4b5563;
        color: #f9fafb;
      }
      .form-input:focus {
        --tw-ring-color: #4f46e5;
        border-color: #4f46e5;
      }
      .file-input-label {
        background-color: #374151;
        border-color: #4b5563;
      }
      .file-input-label:hover {
        background-color: #4b5563;
      }
    </style>
  </head>
  <body class="text-gray-200">
    <!-- Auth Screen -->
    <div
      id="auth-screen"
      class="w-full h-full flex flex-col items-center justify-center p-4"
    >
      <div class="text-center">
        <h1 class="text-3xl font-bold text-white">Moderation Portal</h1>
        <p class="text-gray-400 mt-2 mb-8">
          Please sign in with your authorized Google account to submit a report.
        </p>
        <div
          id="g_id_onload"
          data-client_id="491306000259-eq4b3s56240n079l0jenii4ntmgv11ft.apps.googleusercontent.com"
          data-callback="handleCredentialResponse"
        ></div>
        <div class="g_id_signin" data-type="standard"></div>
      </div>
    </div>

    <!-- Access Denied Screen -->
    <div
      id="denied-screen"
      class="w-full h-full hidden flex-col items-center justify-center p-4 text-center"
    >
      <h1 class="text-3xl font-bold text-red-500">Access Denied</h1>
      <p class="text-gray-400 mt-2">
        The account you signed in with is not authorized to view this content.
      </p>
      <p id="unauthorized-email" class="text-sm text-gray-500 mt-1"></p>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div
      id="main-content"
      class="w-full min-h-full mx-auto hidden flex-col p-4 sm:p-6 md:p-8"
    >
      <div class="max-w-2xl mx-auto w-full">
        <div class="text-center mb-8">
          <h1 class="text-3xl sm:text-4xl font-bold text-white">
            Submit a New Strike Report
          </h1>
          <p class="text-gray-400 mt-2">
            Fill out the details below. All fields are required.
          </p>
        </div>

        <form id="strike-form" class="space-y-6">
          <div>
            <label
              for="moderator-name"
              class="block text-sm font-medium text-gray-300"
              >Your Name (Moderator)</label
            >
            <input
              type="text"
              id="moderator-name"
              required
              class="mt-1 form-input w-full rounded-md shadow-sm focus:ring focus:ring-opacity-50"
            />
          </div>
          <div>
            <label
              for="member-name"
              class="block text-sm font-medium text-gray-300"
              >Member's Name</label
            >
            <input
              type="text"
              id="member-name"
              required
              class="mt-1 form-input w-full rounded-md shadow-sm focus:ring focus:ring-opacity-50"
            />
          </div>
          <div>
            <label
              for="discord-id"
              class="block text-sm font-medium text-gray-300"
              >Member's Discord ID</label
            >
            <input
              type="text"
              id="discord-id"
              required
              class="mt-1 form-input w-full rounded-md shadow-sm focus:ring focus:ring-opacity-50"
            />
          </div>
          <div>
            <label for="reason" class="block text-sm font-medium text-gray-300"
              >Reason for Strike</label
            >
            <textarea
              id="reason"
              rows="4"
              required
              class="mt-1 form-input w-full rounded-md shadow-sm focus:ring focus:ring-opacity-50"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300"
              >Upload Supporting Evidence (Optional)</label
            >
            <div class="mt-1">
              <input type="file" id="evidence-file" class="hidden" />
              <label
                for="evidence-file"
                class="file-input-label cursor-pointer inline-flex items-center px-4 py-2 border rounded-md shadow-sm text-sm font-medium text-white"
              >
                Choose File
              </label>
              <span id="file-name" class="ml-3 text-gray-400"
                >No file selected</span
              >
            </div>
          </div>
          <div class="relative flex items-start">
            <div class="flex h-5 items-center">
              <input
                id="agreement"
                type="checkbox"
                required
                class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500"
              />
            </div>
            <div class="ml-3 text-sm">
              <label for="agreement" class="font-medium text-gray-300"
                >Data Protection & Conduct Agreement</label
              >
              <p class="text-gray-400 text-xs">
                I acknowledge this data is confidential and agree not to share
                it.
              </p>
            </div>
          </div>
          <div>
            <button
              type="submit"
              id="submit-button"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              Submit Report
            </button>
          </div>
        </form>
        <div id="form-message" class="mt-4 text-center"></div>
      </div>
    </div>

    <script>
      // --- DECODE JWT & AUTH ---
      function decodeJwtResponse(token) {
        var base64Url = token.split(".")[1];
        var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        var jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload);
      }
      const authScreen = document.getElementById("auth-screen");
      const deniedScreen = document.getElementById("denied-screen");
      const mainContent = document.getElementById("main-content");
      const unauthorizedEmailEl = document.getElementById("unauthorized-email");

      /**
       * -------------------------------------------------------------------
       * EDIT THIS LIST: Add the Google email addresses of your moderators.
       * -------------------------------------------------------------------
       */
      const AUTHORIZED_EMAILS = [
        "admin@besocia.com",
        "jamie@besocia.com",
        "kylejfernley@gmail.com",
      ];

      function handleCredentialResponse(response) {
        const responsePayload = decodeJwtResponse(response.credential);
        const userEmail = responsePayload.email;
        if (AUTHORIZED_EMAILS.includes(userEmail)) {
          authScreen.style.display = "none";
          deniedScreen.style.display = "none";
          mainContent.style.display = "flex";
          document.getElementById("moderator-name").value =
            responsePayload.name || "";
        } else {
          authScreen.style.display = "none";
          deniedScreen.style.display = "flex";
          unauthorizedEmailEl.textContent = `(${userEmail})`;
        }
      }

      // --- FORM LOGIC ---
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyS1JzB-RFYJ4pkcJRQMaK2kG9fMNtm6YQqFNX28bxPgeVpMd8d20mqyhyktVdiPV0U/exec";
      const form = document.getElementById("strike-form");
      const submitButton = document.getElementById("submit-button");
      const formMessage = document.getElementById("form-message");
      const fileInput = document.getElementById("evidence-file");
      const fileNameSpan = document.getElementById("file-name");

      fileInput.addEventListener("change", () => {
        fileNameSpan.textContent =
          fileInput.files.length > 0
            ? fileInput.files[0].name
            : "No file selected";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = "Submitting...";
        formMessage.textContent = "";

        const file = fileInput.files[0];
        let fileData = { base64: null, name: null, type: null };

        if (file) {
          try {
            fileData = await readFileAsBase64(file);
          } catch (error) {
            formMessage.textContent = "Error reading file.";
            formMessage.className = "text-red-500";
            submitButton.disabled = false;
            submitButton.textContent = "Submit Report";
            return;
          }
        }

        const formData = {
          moderatorName: document.getElementById("moderator-name").value,
          memberName: document.getElementById("member-name").value,
          discordId: document.getElementById("discord-id").value,
          reason: document.getElementById("reason").value,
          agreement: document.getElementById("agreement").checked,
          fileData: fileData.base64,
          fileName: fileData.name,
          fileType: fileData.type,
        };

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors", // Important for simple POST requests to Apps Script
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          // Since 'no-cors' prevents reading the response, we assume success
          // and let the Apps Script handle notifications.
          formMessage.textContent =
            "Report submitted successfully! You can now close this page or submit another report.";
          formMessage.className = "text-green-500";
          form.reset();
          fileNameSpan.textContent = "No file selected";
        } catch (error) {
          console.error("Error:", error);
          formMessage.textContent = "An error occurred during submission.";
          formMessage.className = "text-red-500";
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Submit Report";
        }
      });

      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64String = reader.result.split(",")[1];
            resolve({ base64: base64String, name: file.name, type: file.type });
          };
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
</html>
